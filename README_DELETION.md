# Safe File Deletion Implementation

## –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏–µ–º. –°–∏—Å—Ç–µ–º–∞ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ö–µ—à–∞ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞, –Ω–æ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config.py)
```python
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
FILE_DIRS = [
    "/home2/n1/files",
    "/www/n2.anplus1.com/files"
]

DELETION_LOG_FILE = "/var/log/parser_file_deletions.log"
```

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç directory traversal –∞—Ç–∞–∫
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π —á–µ—Ä–µ–∑ `Path.resolve()` –∏ `is_relative_to()`
- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã –≤–Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª `/var/log/parser_file_deletions.log` –∏ –∫–æ–Ω—Å–æ–ª—å
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ –í—ã–∑–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ: –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —á–µ–∫—Å—É–º–º—ã, –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `old_file_id` –∏–∑ `parse_link_line()`
- ‚úÖ –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —É–¥–∞–ª–µ–Ω–∏—è

## Workflow

```python
def process_single_link(self, link_data):
    # ... —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ ...
    # ... –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –∏ —á–µ–∫—Å—É–º–º—ã ...
    
    # –í–´–ó–û–í –£–î–ê–õ–ï–ù–ò–Ø –°–¢–ê–†–û–ì–û –§–ê–ô–õ–ê
    self.delete_old_file(link_data['old_file_id'], link_data['news_id'])
    
    # ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ dle_files ...
    # ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ dle_post ...
```

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```
2025-09-26 13:16:01,573 - INFO - üóëÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞. old_file_id=123, news_id=456
2025-09-26 13:16:01,573 - INFO - üìÑ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –≤ –ë–î: name='test_app_1.0.0.apk', onserver='2025-01/test_app_1.0.0.apk'
2025-09-26 13:16:01,573 - INFO - üìÅ –û—á–∏—â–µ–Ω–Ω—ã–π –ø—É—Ç—å onserver: '2025-01/test_app_1.0.0.apk'
2025-09-26 13:16:01,574 - INFO - ‚úÖ –ü—É—Ç—å –±–µ–∑–æ–ø–∞—Å–µ–Ω: /home2/n1/files/2025-01/test_app_1.0.0.apk
2025-09-26 13:16:01,574 - INFO - üìä –§–∞–π–ª –Ω–∞–π–¥–µ–Ω! –†–∞–∑–º–µ—Ä: 13 –±–∞–π—Ç, –ø–æ–ª–Ω—ã–π –ø—É—Ç—å: /home2/n1/files/2025-01/test_app_1.0.0.apk
2025-09-26 13:16:01,574 - INFO - ‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω: /home2/n1/files/2025-01/test_app_1.0.0.apk
2025-09-26 13:16:01,574 - INFO - üéâ –§–∞–π–ª —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ. old_file_id=123, filename='test_app_1.0.0.apk'
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω—ã —Ç–µ—Å—Ç—ã:
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ –ø–µ—Ä–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ –≤—Ç–æ—Ä–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ë–î
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø—É—Ç–µ–π (directory traversal)
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó

- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ FILE_DIRS –∏ DELETION_LOG_FILE
- [x] –í—ã–∑–æ–≤ –ø–æ—Å–ª–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ö–µ—à–∞, –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
- [x] SQL –∑–∞–ø—Ä–æ—Å: `SELECT onserver, name FROM dle_files WHERE id = %s`
- [x] –ü–æ–∏—Å–∫ –≤ –¥–≤—É—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- [x] –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π –ø—Ä–æ—Ç–∏–≤ .. –æ–±—Ö–æ–¥–∞
- [x] –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —à–∞–≥–æ–≤
- [x] –í–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –≤ –ª–æ–≥–∏
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π